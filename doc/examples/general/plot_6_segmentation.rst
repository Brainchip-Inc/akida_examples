
.. DO NOT EDIT.
.. THIS FILE WAS AUTOMATICALLY GENERATED BY SPHINX-GALLERY.
.. TO MAKE CHANGES, EDIT THE SOURCE PYTHON FILE:
.. "examples/general/plot_6_segmentation.py"
.. LINE NUMBERS ARE GIVEN BELOW.

.. only:: html

    .. note::
        :class: sphx-glr-download-link-note

        :ref:`Go to the end <sphx_glr_download_examples_general_plot_6_segmentation.py>`
        to download the full example code.

.. rst-class:: sphx-glr-example-title

.. _sphx_glr_examples_general_plot_6_segmentation.py:


Segmentation tutorial
==================================================

This example demonstrates image segmentation with an Akida-compatible model as
illustrated through person segmentation using the `Portrait128 dataset
<https://github.com/anilsathyan7/Portrait-Segmentation>`__.

Using pre-trained models for quick runtime, this example shows the evolution of
model performance for a trained TF-Keras floating point model, a TF-Keras quantized and
Quantization Aware Trained (QAT) model, and an Akida-converted model. Notice that
the performance of the original TF-Keras floating point model is maintained throughout
the model conversion flow.

.. GENERATED FROM PYTHON SOURCE LINES 17-20

1. Load the dataset
~~~~~~~~~~~~~~~~~~~


.. GENERATED FROM PYTHON SOURCE LINES 20-55

.. code-block:: Python


    import os
    import numpy as np
    from akida_models import fetch_file

    # Download validation set from Brainchip data server, it contains 10% of the original dataset
    data_path = fetch_file(fname="val.tar.gz",
                           origin="https://data.brainchip.com/dataset-mirror/portrait128/val.tar.gz",
                           cache_subdir=os.path.join("datasets", "portrait128"),
                           extract=True)

    data_dir = os.path.join(os.path.dirname(data_path), "val")
    x_val = np.load(os.path.join(data_dir, "val_img.npy"))
    y_val = np.load(os.path.join(data_dir, "val_msk.npy")).astype('uint8')
    batch_size = 32
    steps = x_val.shape[0] // 32

    # Visualize some data
    import matplotlib.pyplot as plt

    rng = np.random.default_rng()
    id = rng.integers(0, x_val.shape[0] - 2)

    fig, axs = plt.subplots(3, 3, constrained_layout=True)
    for col in range(3):
        axs[0, col].imshow(x_val[id + col] / 255.)
        axs[0, col].axis('off')
        axs[1, col].imshow(1 - y_val[id + col], cmap='Greys')
        axs[1, col].axis('off')
        axs[2, col].imshow(x_val[id + col] / 255. * y_val[id + col])
        axs[2, col].axis('off')

    fig.suptitle('Image, mask and masked image', fontsize=10)
    plt.show()




.. image-sg:: /examples/general/images/sphx_glr_plot_6_segmentation_001.png
   :alt: Image, mask and masked image
   :srcset: /examples/general/images/sphx_glr_plot_6_segmentation_001.png
   :class: sphx-glr-single-img


.. rst-class:: sphx-glr-script-out

 .. code-block:: none

    Downloading data from https://data.brainchip.com/dataset-mirror/portrait128/val.tar.gz.
            0/267313385 [..............................] - ETA: 0s       180224/267313385 [..............................] - ETA: 1:14       966656/267313385 [..............................] - ETA: 27s       1900544/267313385 [..............................] - ETA: 21s      2572288/267313385 [..............................] - ETA: 20s      4145152/267313385 [..............................] - ETA: 16s      5365760/267313385 [..............................] - ETA: 14s      6316032/267313385 [..............................] - ETA: 14s      7290880/267313385 [..............................] - ETA: 14s      8568832/267313385 [..............................] - ETA: 13s      9445376/267313385 [>.............................] - ETA: 13s     10559488/267313385 [>.............................] - ETA: 13s     11755520/267313385 [>.............................] - ETA: 13s     12656640/267313385 [>.............................] - ETA: 13s     13967360/267313385 [>.............................] - ETA: 13s     14770176/267313385 [>.............................] - ETA: 13s     16031744/267313385 [>.............................] - ETA: 12s     16801792/267313385 [>.............................] - ETA: 13s     18104320/267313385 [=>............................] - ETA: 12s     18923520/267313385 [=>............................] - ETA: 12s     20291584/267313385 [=>............................] - ETA: 12s     21372928/267313385 [=>............................] - ETA: 12s     22503424/267313385 [=>............................] - ETA: 12s     23519232/267313385 [=>............................] - ETA: 12s     24698880/267313385 [=>............................] - ETA: 12s     25731072/267313385 [=>............................] - ETA: 12s     26943488/267313385 [==>...........................] - ETA: 11s     27942912/267313385 [==>...........................] - ETA: 11s     29204480/267313385 [==>...........................] - ETA: 11s     30285824/267313385 [==>...........................] - ETA: 11s     31481856/267313385 [==>...........................] - ETA: 11s     32514048/267313385 [==>...........................] - ETA: 11s     33775616/267313385 [==>...........................] - ETA: 11s     34873344/267313385 [==>...........................] - ETA: 11s     36069376/267313385 [===>..........................] - ETA: 11s     37109760/267313385 [===>..........................] - ETA: 11s     38395904/267313385 [===>..........................] - ETA: 10s     39280640/267313385 [===>..........................] - ETA: 10s     40706048/267313385 [===>..........................] - ETA: 10s     41607168/267313385 [===>..........................] - ETA: 10s     42852352/267313385 [===>..........................] - ETA: 10s     43966464/267313385 [===>..........................] - ETA: 10s     44965888/267313385 [====>.........................] - ETA: 10s     46358528/267313385 [====>.........................] - ETA: 10s     47226880/267313385 [====>.........................] - ETA: 10s     48439296/267313385 [====>.........................] - ETA: 10s     49635328/267313385 [====>.........................] - ETA: 10s     50552832/267313385 [====>.........................] - ETA: 10s     51929088/267313385 [====>.........................] - ETA: 10s     52928512/267313385 [====>.........................] - ETA: 10s     53633024/267313385 [=====>........................] - ETA: 10s     55156736/267313385 [=====>........................] - ETA: 10s     56254464/267313385 [=====>........................] - ETA: 9s      57417728/267313385 [=====>........................] - ETA: 9s     58613760/267313385 [=====>........................] - ETA: 9s     59383808/267313385 [=====>........................] - ETA: 9s     60481536/267313385 [=====>........................] - ETA: 9s     61628416/267313385 [=====>........................] - ETA: 9s     62521344/267313385 [======>.......................] - ETA: 9s     63479808/267313385 [======>.......................] - ETA: 9s     64643072/267313385 [======>.......................] - ETA: 9s     65822720/267313385 [======>.......................] - ETA: 9s     66658304/267313385 [======>.......................] - ETA: 9s     67657728/267313385 [======>.......................] - ETA: 9s     68853760/267313385 [======>.......................] - ETA: 9s     69787648/267313385 [======>.......................] - ETA: 9s     70721536/267313385 [======>.......................] - ETA: 9s     71901184/267313385 [=======>......................] - ETA: 9s     72933376/267313385 [=======>......................] - ETA: 9s     73801728/267313385 [=======>......................] - ETA: 9s     74997760/267313385 [=======>......................] - ETA: 9s     76062720/267313385 [=======>......................] - ETA: 9s     76947456/267313385 [=======>......................] - ETA: 9s     78143488/267313385 [=======>......................] - ETA: 9s     79142912/267313385 [=======>......................] - ETA: 9s     80076800/267313385 [=======>......................] - ETA: 8s     81305600/267313385 [========>.....................] - ETA: 8s     82108416/267313385 [========>.....................] - ETA: 8s     83288064/267313385 [========>.....................] - ETA: 8s     84533248/267313385 [========>.....................] - ETA: 8s     85319680/267313385 [========>.....................] - ETA: 8s     86532096/267313385 [========>.....................] - ETA: 8s     87531520/267313385 [========>.....................] - ETA: 8s     88563712/267313385 [========>.....................] - ETA: 8s     89825280/267313385 [=========>....................] - ETA: 8s     90791936/267313385 [=========>....................] - ETA: 8s     91791360/267313385 [=========>....................] - ETA: 8s     93069312/267313385 [=========>....................] - ETA: 8s     94035968/267313385 [=========>....................] - ETA: 8s     95051776/267313385 [=========>....................] - ETA: 8s     96313344/267313385 [=========>....................] - ETA: 8s     97099776/267313385 [=========>....................] - ETA: 8s     98344960/267313385 [==========>...................] - ETA: 8s     99426304/267313385 [==========>...................] - ETA: 8s    100360192/267313385 [==========>...................] - ETA: 8s    101654528/267313385 [==========>...................] - ETA: 7s    102588416/267313385 [==========>...................] - ETA: 7s    103702528/267313385 [==========>...................] - ETA: 7s    104849408/267313385 [==========>...................] - ETA: 7s    105734144/267313385 [==========>...................] - ETA: 7s    107012096/267313385 [===========>..................] - ETA: 7s    107806720/267313385 [===========>..................] - ETA: 7s    109076480/267313385 [===========>..................] - ETA: 7s    110108672/267313385 [===========>..................] - ETA: 7s    111108096/267313385 [===========>..................] - ETA: 7s    112418816/267313385 [===========>..................] - ETA: 7s    113205248/267313385 [===========>..................] - ETA: 7s    114483200/267313385 [===========>..................] - ETA: 7s    115679232/267313385 [===========>..................] - ETA: 7s    116596736/267313385 [============>.................] - ETA: 7s    117891072/267313385 [============>.................] - ETA: 7s    118644736/267313385 [============>.................] - ETA: 7s    119922688/267313385 [============>.................] - ETA: 7s    121102336/267313385 [============>.................] - ETA: 7s    122019840/267313385 [============>.................] - ETA: 6s    123109376/267313385 [============>.................] - ETA: 6s    124084224/267313385 [============>.................] - ETA: 6s    125378560/267313385 [=============>................] - ETA: 6s    126164992/267313385 [=============>................] - ETA: 6s    127459328/267313385 [=============>................] - ETA: 6s    128278528/267313385 [=============>................] - ETA: 6s    129523712/267313385 [=============>................] - ETA: 6s    130473984/267313385 [=============>................] - ETA: 6s    131604480/267313385 [=============>................] - ETA: 6s    132734976/267313385 [=============>................] - ETA: 6s    133718016/267313385 [==============>...............] - ETA: 6s    134995968/267313385 [==============>...............] - ETA: 6s    136011776/267313385 [==============>...............] - ETA: 6s    137125888/267313385 [==============>...............] - ETA: 6s    138321920/267313385 [==============>...............] - ETA: 6s    139206656/267313385 [==============>...............] - ETA: 6s    140517376/267313385 [==============>...............] - ETA: 6s    141336576/267313385 [==============>...............] - ETA: 6s    142647296/267313385 [===============>..............] - ETA: 5s    143745024/267313385 [===============>..............] - ETA: 5s    144801792/267313385 [===============>..............] - ETA: 5s    146186240/267313385 [===============>..............] - ETA: 5s    147218432/267313385 [===============>..............] - ETA: 5s    148267008/267313385 [===============>..............] - ETA: 5s    149561344/267313385 [===============>..............] - ETA: 5s    150413312/267313385 [===============>..............] - ETA: 5s    151773184/267313385 [================>.............] - ETA: 5s    152969216/267313385 [================>.............] - ETA: 5s    153968640/267313385 [================>.............] - ETA: 5s    155312128/267313385 [================>.............] - ETA: 5s    156164096/267313385 [================>.............] - ETA: 5s    157491200/267313385 [================>.............] - ETA: 5s    158343168/267313385 [================>.............] - ETA: 5s    159637504/267313385 [================>.............] - ETA: 5s    160710656/267313385 [=================>............] - ETA: 5s    161751040/267313385 [=================>............] - ETA: 5s    162914304/267313385 [=================>............] - ETA: 4s    163897344/267313385 [=================>............] - ETA: 4s    165175296/267313385 [=================>............] - ETA: 4s    166109184/267313385 [=================>............] - ETA: 4s    167485440/267313385 [=================>............] - ETA: 4s    168386560/267313385 [=================>............] - ETA: 4s    169730048/267313385 [==================>...........] - ETA: 4s    170729472/267313385 [==================>...........] - ETA: 4s    171909120/267313385 [==================>...........] - ETA: 4s    173056000/267313385 [==================>...........] - ETA: 4s    174137344/267313385 [==================>...........] - ETA: 4s    175398912/267313385 [==================>...........] - ETA: 4s    176398336/267313385 [==================>...........] - ETA: 4s    177725440/267313385 [==================>...........] - ETA: 4s    178642944/267313385 [===================>..........] - ETA: 4s    180019200/267313385 [===================>..........] - ETA: 4s    180953088/267313385 [===================>..........] - ETA: 4s    182263808/267313385 [===================>..........] - ETA: 4s    183181312/267313385 [===================>..........] - ETA: 3s    184557568/267313385 [===================>..........] - ETA: 3s    185442304/267313385 [===================>..........] - ETA: 3s    186851328/267313385 [===================>..........] - ETA: 3s    187736064/267313385 [====================>.........] - ETA: 3s    189079552/267313385 [====================>.........] - ETA: 3s    189931520/267313385 [====================>.........] - ETA: 3s    191217664/267313385 [====================>.........] - ETA: 3s    192159744/267313385 [====================>.........] - ETA: 3s    193404928/267313385 [====================>.........] - ETA: 3s    194404352/267313385 [====================>.........] - ETA: 3s    195633152/267313385 [====================>.........] - ETA: 3s    196796416/267313385 [=====================>........] - ETA: 3s    197844992/267313385 [=====================>........] - ETA: 3s    199155712/267313385 [=====================>........] - ETA: 3s    200228864/267313385 [=====================>........] - ETA: 3s    201498624/267313385 [=====================>........] - ETA: 3s    202440704/267313385 [=====================>........] - ETA: 3s    203808768/267313385 [=====================>........] - ETA: 2s    204906496/267313385 [=====================>........] - ETA: 2s    206102528/267313385 [======================>.......] - ETA: 2s    207134720/267313385 [======================>.......] - ETA: 2s    208429056/267313385 [======================>.......] - ETA: 2s    209477632/267313385 [======================>.......] - ETA: 2s    210755584/267313385 [======================>.......] - ETA: 2s    211804160/267313385 [======================>.......] - ETA: 2s    213114880/267313385 [======================>.......] - ETA: 2s    214065152/267313385 [=======================>......] - ETA: 2s    215408640/267313385 [=======================>......] - ETA: 2s    216498176/267313385 [=======================>......] - ETA: 2s    217735168/267313385 [=======================>......] - ETA: 2s    218570752/267313385 [=======================>......] - ETA: 2s    219717632/267313385 [=======================>......] - ETA: 2s    220930048/267313385 [=======================>......] - ETA: 2s    221822976/267313385 [=======================>......] - ETA: 2s    223158272/267313385 [========================>.....] - ETA: 2s    224124928/267313385 [========================>.....] - ETA: 2s    225484800/267313385 [========================>.....] - ETA: 1s    226451456/267313385 [========================>.....] - ETA: 1s    227631104/267313385 [========================>.....] - ETA: 1s    228909056/267313385 [========================>.....] - ETA: 1s    229892096/267313385 [========================>.....] - ETA: 1s    231284736/267313385 [========================>.....] - ETA: 1s    232153088/267313385 [=========================>....] - ETA: 1s    232914944/267313385 [=========================>....] - ETA: 1s    234299392/267313385 [=========================>....] - ETA: 1s    235298816/267313385 [=========================>....] - ETA: 1s    236396544/267313385 [=========================>....] - ETA: 1s    237314048/267313385 [=========================>....] - ETA: 1s    238116864/267313385 [=========================>....] - ETA: 1s    239247360/267313385 [=========================>....] - ETA: 1s    240148480/267313385 [=========================>....] - ETA: 1s    241033216/267313385 [==========================>...] - ETA: 1s    242180096/267313385 [==========================>...] - ETA: 1s    243326976/267313385 [==========================>...] - ETA: 1s    244064256/267313385 [==========================>...] - ETA: 1s    245178368/267313385 [==========================>...] - ETA: 1s    246317056/267313385 [==========================>...] - ETA: 0s    247095296/267313385 [==========================>...] - ETA: 0s    248274944/267313385 [==========================>...] - ETA: 0s    249470976/267313385 [==========================>...] - ETA: 0s    250257408/267313385 [===========================>..] - ETA: 0s    251437056/267313385 [===========================>..] - ETA: 0s    252567552/267313385 [===========================>..] - ETA: 0s    253370368/267313385 [===========================>..] - ETA: 0s    254582784/267313385 [===========================>..] - ETA: 0s    255483904/267313385 [===========================>..] - ETA: 0s    256581632/267313385 [===========================>..] - ETA: 0s    257794048/267313385 [===========================>..] - ETA: 0s    258580480/267313385 [============================>.] - ETA: 0s    259809280/267313385 [============================>.] - ETA: 0s    260530176/267313385 [============================>.] - ETA: 0s    261808128/267313385 [============================>.] - ETA: 0s    262668288/267313385 [============================>.] - ETA: 0s    263823360/267313385 [============================>.] - ETA: 0s    264880128/267313385 [============================>.] - ETA: 0s    265961472/267313385 [============================>.] - ETA: 0s    267067392/267313385 [============================>.] - ETA: 0s    267313385/267313385 [==============================] - 13s 0us/step
    Download complete.




.. GENERATED FROM PYTHON SOURCE LINES 56-77

2. Load a pre-trained native TF-Keras model
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

The model used in this example is AkidaUNet. It has an AkidaNet (0.5) backbone to extract
features combined with a succession of `separable transposed convolutional
<../../api_reference/akida_models_apis.html#akida_models.layer_blocks.sepconv_transpose_block>`__
blocks to build an image segmentation map. A pre-trained floating point TF-Keras model is
downloaded to save training time.

.. note::
  - The "transposed" convolutional feature is new in Akida 2.0.
  - The "separable transposed" operation is realized through the combination of a QuantizeML custom
    `DepthwiseConv2DTranspose
    <../../api_reference/quantizeml_apis.html#quantizeml.layers.DepthwiseConv2DTranspose>`__ layer
    with a standard pointwise convolution.

The performance of the model is evaluated using both pixel accuracy and `Binary IoU
<https://www.tensorflow.org/api_docs/python/tf/keras/metrics/BinaryIoU>`__. The pixel
accuracy describes how well the model can predict the segmentation mask pixel by pixel
and the Binary IoU takes into account how close the predicted mask is to the ground truth.


.. GENERATED FROM PYTHON SOURCE LINES 77-89

.. code-block:: Python


    from akida_models.model_io import load_model

    # Retrieve the model file from Brainchip data server
    model_file = fetch_file(fname="akida_unet_portrait128.h5",
                            origin="https://data.brainchip.com/models/AkidaV2/akida_unet/akida_unet_portrait128.h5",
                            cache_subdir='models')

    # Load the native TF-Keras pre-trained model
    model_keras = load_model(model_file)
    model_keras.summary()





.. rst-class:: sphx-glr-script-out

 .. code-block:: none

    Downloading data from https://data.brainchip.com/models/AkidaV2/akida_unet/akida_unet_portrait128.h5.
          0/4501976 [..............................] - ETA: 0s     180224/4501976 [>.............................] - ETA: 1s     974848/4501976 [=====>........................] - ETA: 0s    2326528/4501976 [==============>...............] - ETA: 0s    3710976/4501976 [=======================>......] - ETA: 0s    4501976/4501976 [==============================] - 0s 0us/step
    Download complete.
    Model: "akida_unet"
    _________________________________________________________________
     Layer (type)                Output Shape              Param #   
    =================================================================
     input (InputLayer)          [(None, 128, 128, 3)]     0         
                                                                 
     rescaling (Rescaling)       (None, 128, 128, 3)       0         
                                                                 
     conv_0 (Conv2D)             (None, 64, 64, 16)        432       
                                                                 
     conv_0/BN (BatchNormalizat  (None, 64, 64, 16)        64        
     ion)                                                            
                                                                 
     conv_0/relu (ReLU)          (None, 64, 64, 16)        0         
                                                                 
     conv_1 (Conv2D)             (None, 64, 64, 32)        4608      
                                                                 
     conv_1/BN (BatchNormalizat  (None, 64, 64, 32)        128       
     ion)                                                            
                                                                 
     conv_1/relu (ReLU)          (None, 64, 64, 32)        0         
                                                                 
     conv_2 (Conv2D)             (None, 32, 32, 64)        18432     
                                                                 
     conv_2/BN (BatchNormalizat  (None, 32, 32, 64)        256       
     ion)                                                            
                                                                 
     conv_2/relu (ReLU)          (None, 32, 32, 64)        0         
                                                                 
     conv_3 (Conv2D)             (None, 32, 32, 64)        36864     
                                                                 
     conv_3/BN (BatchNormalizat  (None, 32, 32, 64)        256       
     ion)                                                            
                                                                 
     conv_3/relu (ReLU)          (None, 32, 32, 64)        0         
                                                                 
     dw_separable_4 (DepthwiseC  (None, 16, 16, 64)        576       
     onv2D)                                                          
                                                                 
     pw_separable_4 (Conv2D)     (None, 16, 16, 128)       8192      
                                                                 
     pw_separable_4/BN (BatchNo  (None, 16, 16, 128)       512       
     rmalization)                                                    
                                                                 
     pw_separable_4/relu (ReLU)  (None, 16, 16, 128)       0         
                                                                 
     dw_separable_5 (DepthwiseC  (None, 16, 16, 128)       1152      
     onv2D)                                                          
                                                                 
     pw_separable_5 (Conv2D)     (None, 16, 16, 128)       16384     
                                                                 
     pw_separable_5/BN (BatchNo  (None, 16, 16, 128)       512       
     rmalization)                                                    
                                                                 
     pw_separable_5/relu (ReLU)  (None, 16, 16, 128)       0         
                                                                 
     dw_separable_6 (DepthwiseC  (None, 8, 8, 128)         1152      
     onv2D)                                                          
                                                                 
     pw_separable_6 (Conv2D)     (None, 8, 8, 256)         32768     
                                                                 
     pw_separable_6/BN (BatchNo  (None, 8, 8, 256)         1024      
     rmalization)                                                    
                                                                 
     pw_separable_6/relu (ReLU)  (None, 8, 8, 256)         0         
                                                                 
     dw_separable_7 (DepthwiseC  (None, 8, 8, 256)         2304      
     onv2D)                                                          
                                                                 
     pw_separable_7 (Conv2D)     (None, 8, 8, 256)         65536     
                                                                 
     pw_separable_7/BN (BatchNo  (None, 8, 8, 256)         1024      
     rmalization)                                                    
                                                                 
     pw_separable_7/relu (ReLU)  (None, 8, 8, 256)         0         
                                                                 
     dw_separable_8 (DepthwiseC  (None, 8, 8, 256)         2304      
     onv2D)                                                          
                                                                 
     pw_separable_8 (Conv2D)     (None, 8, 8, 256)         65536     
                                                                 
     pw_separable_8/BN (BatchNo  (None, 8, 8, 256)         1024      
     rmalization)                                                    
                                                                 
     pw_separable_8/relu (ReLU)  (None, 8, 8, 256)         0         
                                                                 
     dw_separable_9 (DepthwiseC  (None, 8, 8, 256)         2304      
     onv2D)                                                          
                                                                 
     pw_separable_9 (Conv2D)     (None, 8, 8, 256)         65536     
                                                                 
     pw_separable_9/BN (BatchNo  (None, 8, 8, 256)         1024      
     rmalization)                                                    
                                                                 
     pw_separable_9/relu (ReLU)  (None, 8, 8, 256)         0         
                                                                 
     dw_separable_10 (Depthwise  (None, 8, 8, 256)         2304      
     Conv2D)                                                         
                                                                 
     pw_separable_10 (Conv2D)    (None, 8, 8, 256)         65536     
                                                                 
     pw_separable_10/BN (BatchN  (None, 8, 8, 256)         1024      
     ormalization)                                                   
                                                                 
     pw_separable_10/relu (ReLU  (None, 8, 8, 256)         0         
     )                                                               
                                                                 
     dw_separable_11 (Depthwise  (None, 8, 8, 256)         2304      
     Conv2D)                                                         
                                                                 
     pw_separable_11 (Conv2D)    (None, 8, 8, 256)         65536     
                                                                 
     pw_separable_11/BN (BatchN  (None, 8, 8, 256)         1024      
     ormalization)                                                   
                                                                 
     pw_separable_11/relu (ReLU  (None, 8, 8, 256)         0         
     )                                                               
                                                                 
     dw_separable_12 (Depthwise  (None, 4, 4, 256)         2304      
     Conv2D)                                                         
                                                                 
     pw_separable_12 (Conv2D)    (None, 4, 4, 512)         131072    
                                                                 
     pw_separable_12/BN (BatchN  (None, 4, 4, 512)         2048      
     ormalization)                                                   
                                                                 
     pw_separable_12/relu (ReLU  (None, 4, 4, 512)         0         
     )                                                               
                                                                 
     dw_separable_13 (Depthwise  (None, 4, 4, 512)         4608      
     Conv2D)                                                         
                                                                 
     pw_separable_13 (Conv2D)    (None, 4, 4, 512)         262144    
                                                                 
     pw_separable_13/BN (BatchN  (None, 4, 4, 512)         2048      
     ormalization)                                                   
                                                                 
     pw_separable_13/relu (ReLU  (None, 4, 4, 512)         0         
     )                                                               
                                                                 
     dw_sepconv_t_0 (DepthwiseC  (None, 8, 8, 512)         5120      
     onv2DTranspose)                                                 
                                                                 
     pw_sepconv_t_0 (Conv2D)     (None, 8, 8, 256)         131328    
                                                                 
     pw_sepconv_t_0/BN (BatchNo  (None, 8, 8, 256)         1024      
     rmalization)                                                    
                                                                 
     pw_sepconv_t_0/relu (ReLU)  (None, 8, 8, 256)         0         
                                                                 
     dropout (Dropout)           (None, 8, 8, 256)         0         
                                                                 
     dw_sepconv_t_1 (DepthwiseC  (None, 16, 16, 256)       2560      
     onv2DTranspose)                                                 
                                                                 
     pw_sepconv_t_1 (Conv2D)     (None, 16, 16, 128)       32896     
                                                                 
     pw_sepconv_t_1/BN (BatchNo  (None, 16, 16, 128)       512       
     rmalization)                                                    
                                                                 
     pw_sepconv_t_1/relu (ReLU)  (None, 16, 16, 128)       0         
                                                                 
     dropout_1 (Dropout)         (None, 16, 16, 128)       0         
                                                                 
     dw_sepconv_t_2 (DepthwiseC  (None, 32, 32, 128)       1280      
     onv2DTranspose)                                                 
                                                                 
     pw_sepconv_t_2 (Conv2D)     (None, 32, 32, 64)        8256      
                                                                 
     pw_sepconv_t_2/BN (BatchNo  (None, 32, 32, 64)        256       
     rmalization)                                                    
                                                                 
     pw_sepconv_t_2/relu (ReLU)  (None, 32, 32, 64)        0         
                                                                 
     dropout_2 (Dropout)         (None, 32, 32, 64)        0         
                                                                 
     dw_sepconv_t_3 (DepthwiseC  (None, 64, 64, 64)        640       
     onv2DTranspose)                                                 
                                                                 
     pw_sepconv_t_3 (Conv2D)     (None, 64, 64, 32)        2080      
                                                                 
     pw_sepconv_t_3/BN (BatchNo  (None, 64, 64, 32)        128       
     rmalization)                                                    
                                                                 
     pw_sepconv_t_3/relu (ReLU)  (None, 64, 64, 32)        0         
                                                                 
     dropout_3 (Dropout)         (None, 64, 64, 32)        0         
                                                                 
     dw_sepconv_t_4 (DepthwiseC  (None, 128, 128, 32)      320       
     onv2DTranspose)                                                 
                                                                 
     pw_sepconv_t_4 (Conv2D)     (None, 128, 128, 16)      528       
                                                                 
     pw_sepconv_t_4/BN (BatchNo  (None, 128, 128, 16)      64        
     rmalization)                                                    
                                                                 
     pw_sepconv_t_4/relu (ReLU)  (None, 128, 128, 16)      0         
                                                                 
     dropout_4 (Dropout)         (None, 128, 128, 16)      0         
                                                                 
     head (Conv2D)               (None, 128, 128, 1)       17        
                                                                 
    =================================================================
    Total params: 1058865 (4.04 MB)
    Trainable params: 1051889 (4.01 MB)
    Non-trainable params: 6976 (27.25 KB)
    _________________________________________________________________




.. GENERATED FROM PYTHON SOURCE LINES 90-101

.. code-block:: Python


    from tf_keras.metrics import BinaryIoU

    # Compile the native TF-Keras model (required to evaluate the metrics)
    model_keras.compile(loss='binary_crossentropy', metrics=[BinaryIoU(), 'accuracy'])

    # Check Keras model performance
    _, biou, acc = model_keras.evaluate(x_val, y_val, steps=steps, verbose=0)

    print(f"TF-Keras binary IoU / pixel accuracy: {biou:.4f} / {100*acc:.2f}%")





.. rst-class:: sphx-glr-script-out

 .. code-block:: none

    TF-Keras binary IoU / pixel accuracy: 0.9355 / 96.78%




.. GENERATED FROM PYTHON SOURCE LINES 102-110

3. Load a pre-trained quantized Keras model
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

The next step is to quantize and potentially perform Quantize Aware Training (QAT) on the
TF-Keras model from the previous step. After the TF-Keras model is quantized to 8-bits for
all weights and activations, QAT is used to maintain the performance of the quantized
model. Again, a pre-trained model is downloaded to save runtime.


.. GENERATED FROM PYTHON SOURCE LINES 110-117

.. code-block:: Python


    from akida_models import akida_unet_portrait128_pretrained

    # Load the pre-trained quantized model
    model_quantized_keras = akida_unet_portrait128_pretrained()
    model_quantized_keras.summary()





.. rst-class:: sphx-glr-script-out

 .. code-block:: none

    Downloading data from https://data.brainchip.com/models/AkidaV2/akida_unet/akida_unet_portrait128_i8_w8_a8.h5.
          0/4527816 [..............................] - ETA: 0s     147456/4527816 [..............................] - ETA: 1s     999424/4527816 [=====>........................] - ETA: 0s    2383872/4527816 [==============>...............] - ETA: 0s    3211264/4527816 [====================>.........] - ETA: 0s    4527816/4527816 [==============================] - 0s 0us/step
    Download complete.
    Model: "akida_unet"
    _________________________________________________________________
     Layer (type)                Output Shape              Param #   
    =================================================================
     input (InputLayer)          [(None, 128, 128, 3)]     0         
                                                                 
     rescaling (QuantizedRescal  (None, 128, 128, 3)       0         
     ing)                                                            
                                                                 
     conv_0 (QuantizedConv2D)    (None, 64, 64, 16)        448       
                                                                 
     conv_0/relu (QuantizedReLU  (None, 64, 64, 16)        32        
     )                                                               
                                                                 
     conv_1 (QuantizedConv2D)    (None, 64, 64, 32)        4640      
                                                                 
     conv_1/relu (QuantizedReLU  (None, 64, 64, 32)        64        
     )                                                               
                                                                 
     conv_2 (QuantizedConv2D)    (None, 32, 32, 64)        18496     
                                                                 
     conv_2/relu (QuantizedReLU  (None, 32, 32, 64)        128       
     )                                                               
                                                                 
     conv_3 (QuantizedConv2D)    (None, 32, 32, 64)        36928     
                                                                 
     conv_3/relu (QuantizedReLU  (None, 32, 32, 64)        128       
     )                                                               
                                                                 
     dw_separable_4 (QuantizedD  (None, 16, 16, 64)        704       
     epthwiseConv2D)                                                 
                                                                 
     pw_separable_4 (QuantizedC  (None, 16, 16, 128)       8320      
     onv2D)                                                          
                                                                 
     pw_separable_4/relu (Quant  (None, 16, 16, 128)       256       
     izedReLU)                                                       
                                                                 
     dw_separable_5 (QuantizedD  (None, 16, 16, 128)       1408      
     epthwiseConv2D)                                                 
                                                                 
     pw_separable_5 (QuantizedC  (None, 16, 16, 128)       16512     
     onv2D)                                                          
                                                                 
     pw_separable_5/relu (Quant  (None, 16, 16, 128)       256       
     izedReLU)                                                       
                                                                 
     dw_separable_6 (QuantizedD  (None, 8, 8, 128)         1408      
     epthwiseConv2D)                                                 
                                                                 
     pw_separable_6 (QuantizedC  (None, 8, 8, 256)         33024     
     onv2D)                                                          
                                                                 
     pw_separable_6/relu (Quant  (None, 8, 8, 256)         512       
     izedReLU)                                                       
                                                                 
     dw_separable_7 (QuantizedD  (None, 8, 8, 256)         2816      
     epthwiseConv2D)                                                 
                                                                 
     pw_separable_7 (QuantizedC  (None, 8, 8, 256)         65792     
     onv2D)                                                          
                                                                 
     pw_separable_7/relu (Quant  (None, 8, 8, 256)         512       
     izedReLU)                                                       
                                                                 
     dw_separable_8 (QuantizedD  (None, 8, 8, 256)         2816      
     epthwiseConv2D)                                                 
                                                                 
     pw_separable_8 (QuantizedC  (None, 8, 8, 256)         65792     
     onv2D)                                                          
                                                                 
     pw_separable_8/relu (Quant  (None, 8, 8, 256)         512       
     izedReLU)                                                       
                                                                 
     dw_separable_9 (QuantizedD  (None, 8, 8, 256)         2816      
     epthwiseConv2D)                                                 
                                                                 
     pw_separable_9 (QuantizedC  (None, 8, 8, 256)         65792     
     onv2D)                                                          
                                                                 
     pw_separable_9/relu (Quant  (None, 8, 8, 256)         512       
     izedReLU)                                                       
                                                                 
     dw_separable_10 (Quantized  (None, 8, 8, 256)         2816      
     DepthwiseConv2D)                                                
                                                                 
     pw_separable_10 (Quantized  (None, 8, 8, 256)         65792     
     Conv2D)                                                         
                                                                 
     pw_separable_10/relu (Quan  (None, 8, 8, 256)         512       
     tizedReLU)                                                      
                                                                 
     dw_separable_11 (Quantized  (None, 8, 8, 256)         2816      
     DepthwiseConv2D)                                                
                                                                 
     pw_separable_11 (Quantized  (None, 8, 8, 256)         65792     
     Conv2D)                                                         
                                                                 
     pw_separable_11/relu (Quan  (None, 8, 8, 256)         512       
     tizedReLU)                                                      
                                                                 
     dw_separable_12 (Quantized  (None, 4, 4, 256)         2816      
     DepthwiseConv2D)                                                
                                                                 
     pw_separable_12 (Quantized  (None, 4, 4, 512)         131584    
     Conv2D)                                                         
                                                                 
     pw_separable_12/relu (Quan  (None, 4, 4, 512)         1024      
     tizedReLU)                                                      
                                                                 
     dw_separable_13 (Quantized  (None, 4, 4, 512)         5632      
     DepthwiseConv2D)                                                
                                                                 
     pw_separable_13 (Quantized  (None, 4, 4, 512)         262656    
     Conv2D)                                                         
                                                                 
     pw_separable_13/relu (Quan  (None, 4, 4, 512)         1024      
     tizedReLU)                                                      
                                                                 
     dw_sepconv_t_0 (QuantizedD  (None, 8, 8, 512)         6144      
     epthwiseConv2DTranspose)                                        
                                                                 
     pw_sepconv_t_0 (QuantizedC  (None, 8, 8, 256)         131328    
     onv2D)                                                          
                                                                 
     pw_sepconv_t_0/relu (Quant  (None, 8, 8, 256)         512       
     izedReLU)                                                       
                                                                 
     dropout (QuantizedDropout)  (None, 8, 8, 256)         0         
                                                                 
     dw_sepconv_t_1 (QuantizedD  (None, 16, 16, 256)       3072      
     epthwiseConv2DTranspose)                                        
                                                                 
     pw_sepconv_t_1 (QuantizedC  (None, 16, 16, 128)       32896     
     onv2D)                                                          
                                                                 
     pw_sepconv_t_1/relu (Quant  (None, 16, 16, 128)       256       
     izedReLU)                                                       
                                                                 
     dropout_1 (QuantizedDropou  (None, 16, 16, 128)       0         
     t)                                                              
                                                                 
     dw_sepconv_t_2 (QuantizedD  (None, 32, 32, 128)       1536      
     epthwiseConv2DTranspose)                                        
                                                                 
     pw_sepconv_t_2 (QuantizedC  (None, 32, 32, 64)        8256      
     onv2D)                                                          
                                                                 
     pw_sepconv_t_2/relu (Quant  (None, 32, 32, 64)        128       
     izedReLU)                                                       
                                                                 
     dropout_2 (QuantizedDropou  (None, 32, 32, 64)        0         
     t)                                                              
                                                                 
     dw_sepconv_t_3 (QuantizedD  (None, 64, 64, 64)        768       
     epthwiseConv2DTranspose)                                        
                                                                 
     pw_sepconv_t_3 (QuantizedC  (None, 64, 64, 32)        2080      
     onv2D)                                                          
                                                                 
     pw_sepconv_t_3/relu (Quant  (None, 64, 64, 32)        64        
     izedReLU)                                                       
                                                                 
     dropout_3 (QuantizedDropou  (None, 64, 64, 32)        0         
     t)                                                              
                                                                 
     dw_sepconv_t_4 (QuantizedD  (None, 128, 128, 32)      384       
     epthwiseConv2DTranspose)                                        
                                                                 
     pw_sepconv_t_4 (QuantizedC  (None, 128, 128, 16)      528       
     onv2D)                                                          
                                                                 
     pw_sepconv_t_4/relu (Quant  (None, 128, 128, 16)      32        
     izedReLU)                                                       
                                                                 
     dropout_4 (QuantizedDropou  (None, 128, 128, 16)      0         
     t)                                                              
                                                                 
     head (QuantizedConv2D)      (None, 128, 128, 1)       19        
                                                                 
     dequantizer (Dequantizer)   (None, 128, 128, 1)       0         
                                                                 
    =================================================================
    Total params: 1061603 (4.05 MB)
    Trainable params: 1047905 (4.00 MB)
    Non-trainable params: 13698 (53.51 KB)
    _________________________________________________________________




.. GENERATED FROM PYTHON SOURCE LINES 118-127

.. code-block:: Python


    # Compile the quantized TF-Keras model (required to evaluate the metrics)
    model_quantized_keras.compile(loss='binary_crossentropy', metrics=[BinaryIoU(), 'accuracy'])

    # Check Keras model performance
    _, biou, acc = model_quantized_keras.evaluate(x_val, y_val, steps=steps, verbose=0)

    print(f"TF-Keras quantized binary IoU / pixel accuracy: {biou:.4f} / {100*acc:.2f}%")





.. rst-class:: sphx-glr-script-out

 .. code-block:: none

    TF-Keras quantized binary IoU / pixel accuracy: 0.9334 / 96.71%




.. GENERATED FROM PYTHON SOURCE LINES 128-135

4. Conversion to Akida
~~~~~~~~~~~~~~~~~~~~~~

Finally, the quantized TF-Keras model from the previous step is converted into an Akida
model and its performance is evaluated. Note that the original performance of the TF-Keras
floating point model is maintained throughout the conversion process in this example.


.. GENERATED FROM PYTHON SOURCE LINES 135-142

.. code-block:: Python


    from cnn2snn import convert

    # Convert the model
    model_akida = convert(model_quantized_keras)
    model_akida.summary()





.. rst-class:: sphx-glr-script-out

 .. code-block:: none

                      Model Summary                  
    _________________________________________________
    Input shape    Output shape   Sequences  Layers
    =================================================
    [128, 128, 3]  [128, 128, 1]  1          36    
    _________________________________________________

    _____________________________________________________________________________
    Layer (type)                               Output shape    Kernel shape    

    ====================== SW/conv_0-dequantizer (Software) =====================

    conv_0 (InputConv2D)                       [64, 64, 16]    (3, 3, 3, 16)   
    _____________________________________________________________________________
    conv_1 (Conv2D)                            [64, 64, 32]    (3, 3, 16, 32)  
    _____________________________________________________________________________
    conv_2 (Conv2D)                            [32, 32, 64]    (3, 3, 32, 64)  
    _____________________________________________________________________________
    conv_3 (Conv2D)                            [32, 32, 64]    (3, 3, 64, 64)  
    _____________________________________________________________________________
    dw_separable_4 (DepthwiseConv2D)           [16, 16, 64]    (3, 3, 64, 1)   
    _____________________________________________________________________________
    pw_separable_4 (Conv2D)                    [16, 16, 128]   (1, 1, 64, 128) 
    _____________________________________________________________________________
    dw_separable_5 (DepthwiseConv2D)           [16, 16, 128]   (3, 3, 128, 1)  
    _____________________________________________________________________________
    pw_separable_5 (Conv2D)                    [16, 16, 128]   (1, 1, 128, 128)
    _____________________________________________________________________________
    dw_separable_6 (DepthwiseConv2D)           [8, 8, 128]     (3, 3, 128, 1)  
    _____________________________________________________________________________
    pw_separable_6 (Conv2D)                    [8, 8, 256]     (1, 1, 128, 256)
    _____________________________________________________________________________
    dw_separable_7 (DepthwiseConv2D)           [8, 8, 256]     (3, 3, 256, 1)  
    _____________________________________________________________________________
    pw_separable_7 (Conv2D)                    [8, 8, 256]     (1, 1, 256, 256)
    _____________________________________________________________________________
    dw_separable_8 (DepthwiseConv2D)           [8, 8, 256]     (3, 3, 256, 1)  
    _____________________________________________________________________________
    pw_separable_8 (Conv2D)                    [8, 8, 256]     (1, 1, 256, 256)
    _____________________________________________________________________________
    dw_separable_9 (DepthwiseConv2D)           [8, 8, 256]     (3, 3, 256, 1)  
    _____________________________________________________________________________
    pw_separable_9 (Conv2D)                    [8, 8, 256]     (1, 1, 256, 256)
    _____________________________________________________________________________
    dw_separable_10 (DepthwiseConv2D)          [8, 8, 256]     (3, 3, 256, 1)  
    _____________________________________________________________________________
    pw_separable_10 (Conv2D)                   [8, 8, 256]     (1, 1, 256, 256)
    _____________________________________________________________________________
    dw_separable_11 (DepthwiseConv2D)          [8, 8, 256]     (3, 3, 256, 1)  
    _____________________________________________________________________________
    pw_separable_11 (Conv2D)                   [8, 8, 256]     (1, 1, 256, 256)
    _____________________________________________________________________________
    dw_separable_12 (DepthwiseConv2D)          [4, 4, 256]     (3, 3, 256, 1)  
    _____________________________________________________________________________
    pw_separable_12 (Conv2D)                   [4, 4, 512]     (1, 1, 256, 512)
    _____________________________________________________________________________
    dw_separable_13 (DepthwiseConv2D)          [4, 4, 512]     (3, 3, 512, 1)  
    _____________________________________________________________________________
    pw_separable_13 (Conv2D)                   [4, 4, 512]     (1, 1, 512, 512)
    _____________________________________________________________________________
    dw_sepconv_t_0 (DepthwiseConv2DTranspose)  [8, 8, 512]     (3, 3, 512, 1)  
    _____________________________________________________________________________
    pw_sepconv_t_0 (Conv2D)                    [8, 8, 256]     (1, 1, 512, 256)
    _____________________________________________________________________________
    dw_sepconv_t_1 (DepthwiseConv2DTranspose)  [16, 16, 256]   (3, 3, 256, 1)  
    _____________________________________________________________________________
    pw_sepconv_t_1 (Conv2D)                    [16, 16, 128]   (1, 1, 256, 128)
    _____________________________________________________________________________
    dw_sepconv_t_2 (DepthwiseConv2DTranspose)  [32, 32, 128]   (3, 3, 128, 1)  
    _____________________________________________________________________________
    pw_sepconv_t_2 (Conv2D)                    [32, 32, 64]    (1, 1, 128, 64) 
    _____________________________________________________________________________
    dw_sepconv_t_3 (DepthwiseConv2DTranspose)  [64, 64, 64]    (3, 3, 64, 1)   
    _____________________________________________________________________________
    pw_sepconv_t_3 (Conv2D)                    [64, 64, 32]    (1, 1, 64, 32)  
    _____________________________________________________________________________
    dw_sepconv_t_4 (DepthwiseConv2DTranspose)  [128, 128, 32]  (3, 3, 32, 1)   
    _____________________________________________________________________________
    pw_sepconv_t_4 (Conv2D)                    [128, 128, 16]  (1, 1, 32, 16)  
    _____________________________________________________________________________
    head (Conv2D)                              [128, 128, 1]   (1, 1, 16, 1)   
    _____________________________________________________________________________
    dequantizer (Dequantizer)                  [128, 128, 1]   N/A             
    _____________________________________________________________________________




.. GENERATED FROM PYTHON SOURCE LINES 143-174

.. code-block:: Python


    import tf_keras as keras

    # Check Akida model performance
    labels, pots = None, None

    for s in range(steps):
        batch = x_val[s * batch_size: (s + 1) * batch_size, :]
        label_batch = y_val[s * batch_size: (s + 1) * batch_size, :]
        pots_batch = model_akida.predict(batch.astype('uint8'))

        if labels is None:
            labels = label_batch
            pots = pots_batch
        else:
            labels = np.concatenate((labels, label_batch))
            pots = np.concatenate((pots, pots_batch))
    preds = keras.activations.sigmoid(pots)

    m_binary_iou = keras.metrics.BinaryIoU(target_class_ids=[0, 1], threshold=0.5)
    m_binary_iou.update_state(labels, preds)
    binary_iou = m_binary_iou.result().numpy()

    m_accuracy = keras.metrics.Accuracy()
    m_accuracy.update_state(labels, preds > 0.5)
    accuracy = m_accuracy.result().numpy()
    print(f"Akida binary IoU / pixel accuracy: {binary_iou:.4f} / {100*accuracy:.2f}%")

    # For non-regression purpose
    assert binary_iou > 0.9





.. rst-class:: sphx-glr-script-out

 .. code-block:: none

    Akida binary IoU / pixel accuracy: 0.9235 / 96.66%




.. GENERATED FROM PYTHON SOURCE LINES 175-182

5. Segment a single image
~~~~~~~~~~~~~~~~~~~~~~~~~

For visualization of the person segmentation performed by the Akida model, display a
single image along with the segmentation produced by the original floating point model
and the ground truth segmentation.


.. GENERATED FROM PYTHON SOURCE LINES 182-204

.. code-block:: Python


    import matplotlib.pyplot as plt

    # Estimate age on a random single image and display TF-Keras and Akida outputs
    sample = np.expand_dims(x_val[id, :], 0)
    keras_out = model_keras(sample)
    akida_out = keras.activations.sigmoid(model_akida.forward(sample.astype('uint8')))

    fig, axs = plt.subplots(1, 3, constrained_layout=True)
    axs[0].imshow(keras_out[0] * sample[0] / 255.)
    axs[0].set_title('Keras segmentation', fontsize=10)
    axs[0].axis('off')

    axs[1].imshow(akida_out[0] * sample[0] / 255.)
    axs[1].set_title('Akida segmentation', fontsize=10)
    axs[1].axis('off')

    axs[2].imshow(y_val[id] * sample[0] / 255.)
    axs[2].set_title('Expected segmentation', fontsize=10)
    axs[2].axis('off')

    plt.show()



.. image-sg:: /examples/general/images/sphx_glr_plot_6_segmentation_002.png
   :alt: Keras segmentation, Akida segmentation, Expected segmentation
   :srcset: /examples/general/images/sphx_glr_plot_6_segmentation_002.png
   :class: sphx-glr-single-img






.. rst-class:: sphx-glr-timing

   **Total running time of the script:** (2 minutes 3.416 seconds)


.. _sphx_glr_download_examples_general_plot_6_segmentation.py:

.. only:: html

  .. container:: sphx-glr-footer sphx-glr-footer-example

    .. container:: sphx-glr-download sphx-glr-download-jupyter

      :download:`Download Jupyter notebook: plot_6_segmentation.ipynb <plot_6_segmentation.ipynb>`

    .. container:: sphx-glr-download sphx-glr-download-python

      :download:`Download Python source code: plot_6_segmentation.py <plot_6_segmentation.py>`

    .. container:: sphx-glr-download sphx-glr-download-zip

      :download:`Download zipped: plot_6_segmentation.zip <plot_6_segmentation.zip>`


.. only:: html

 .. rst-class:: sphx-glr-signature

    `Gallery generated by Sphinx-Gallery <https://sphinx-gallery.github.io>`_
